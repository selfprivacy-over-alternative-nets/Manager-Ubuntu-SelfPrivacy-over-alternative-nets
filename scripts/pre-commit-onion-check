#!/bin/bash
# pre-commit hook — Block commits containing a live .onion domain
#
# Protection layers:
#   1. If the VM is running, get its current .onion and block if found in staged files
#   2. Check .onion-blocklist for previously recorded .onion addresses
#   3. Warn if any 56-char .onion address appears in staged non-binary files
#
# Install: bash scripts/install-hooks.sh

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PubkeyAuthentication=no -o PreferredAuthentications=password -o LogLevel=ERROR -o ConnectTimeout=2"
REPO_ROOT="$(git rev-parse --show-toplevel)"
BLOCKLIST="$REPO_ROOT/.onion-blocklist"
BLOCKED=""

# ── 1. Check if VM is running and get its live .onion ──────────────────────
LIVE_ONION=""
if command -v sshpass &>/dev/null; then
    LIVE_ONION=$(sshpass -p '' ssh -n $SSH_OPTS -p 2222 root@localhost \
        cat /var/lib/tor/hidden_service/hostname 2>/dev/null || true)
fi

if [ -n "$LIVE_ONION" ]; then
    # The VM is running with a live .onion — check staged files
    # Use git diff --cached to search staged content (works for binary & text)
    if git diff --cached --diff-filter=d -G "$LIVE_ONION" --name-only 2>/dev/null | grep -q .; then
        BLOCKED="$BLOCKED
  LIVE .onion found in staged files: $LIVE_ONION
  Files:"
        while IFS= read -r file; do
            BLOCKED="$BLOCKED
    - $file"
        done < <(git diff --cached --diff-filter=d -G "$LIVE_ONION" --name-only 2>/dev/null)
    fi

    # Also check staged .cast files (these are text, searchable)
    for f in $(git diff --cached --name-only --diff-filter=d 2>/dev/null | grep -E '\.(cast|json|md|sh|txt)$' || true); do
        if git show ":$f" 2>/dev/null | grep -qF "$LIVE_ONION"; then
            if ! echo "$BLOCKED" | grep -qF "$f"; then
                BLOCKED="$BLOCKED
    - $f (contains live .onion)"
            fi
        fi
    done
fi

# ── 2. Check blocklist ────────────────────────────────────────────────────
if [ -f "$BLOCKLIST" ]; then
    while IFS= read -r onion; do
        # Skip comments and empty lines
        [[ "$onion" =~ ^#.*$ ]] && continue
        [ -z "$onion" ] && continue

        for f in $(git diff --cached --name-only --diff-filter=d 2>/dev/null | grep -E '\.(cast|json|md|sh|txt)$' || true); do
            if git show ":$f" 2>/dev/null | grep -qF "$onion"; then
                BLOCKED="$BLOCKED
  Blocklisted .onion '$onion' found in: $f"
            fi
        done
    done < "$BLOCKLIST"
fi

# ── 3. Verdict ─────────────────────────────────────────────────────────────
if [ -n "$BLOCKED" ]; then
    echo ""
    echo -e "${RED}BLOCKED: Live or blocklisted .onion domain found in staged files!${NC}"
    echo -e "$BLOCKED"
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo -e "  1. Run ${GREEN}bash scripts/scrub-and-push.sh${NC} to destroy the Tor keys"
    echo -e "  2. If GIF files contain the .onion, that's expected — but the keys"
    echo -e "     must be destroyed first so the .onion is dead before pushing."
    echo -e "  3. To bypass: ${YELLOW}git commit --no-verify${NC} (use with caution)"
    echo ""
    exit 1
fi

exit 0
