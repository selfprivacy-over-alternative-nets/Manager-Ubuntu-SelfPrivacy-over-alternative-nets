name: Android APK Build

on:
  push:
    branches: [ main, feature/* ]
    paths:
      - 'flutter-app/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'flutter-app/**'
      - '.github/workflows/android-build.yml'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: flutter-app/selfprivacy.org.app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.2'
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build production debug APK
        run: |
          flutter build apk --flavor production --debug \
            --dart-define=ONION_DOMAIN=placeholder.onion \
            --dart-define=API_TOKEN=ci-build-token

      - name: Verify APK is valid
        run: |
          APK="build/app/outputs/flutter-apk/app-production-debug.apk"
          echo "=== APK Info ==="
          ls -lh "$APK"
          file "$APK"
          # APK is a zip archive â€” verify integrity
          unzip -t "$APK" > /dev/null 2>&1 && echo "APK integrity: OK" || { echo "APK integrity: FAILED"; exit 1; }
          # Verify it contains the expected Android manifest
          unzip -l "$APK" | grep -q "AndroidManifest.xml" && echo "AndroidManifest.xml: present" || { echo "AndroidManifest.xml: MISSING"; exit 1; }
          # Verify it contains Dart code
          unzip -l "$APK" | grep -q "libflutter.so" && echo "libflutter.so: present" || { echo "libflutter.so: MISSING"; exit 1; }

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: selfprivacy-android-debug
          path: flutter-app/selfprivacy.org.app/build/app/outputs/flutter-apk/app-production-debug.apk
          retention-days: 30
